deploy:
  phases:
    install:
      commands:
        - pip install -r requirements.txt
        - wget https://get.helm.sh/helm-v3.11.3-linux-amd64.tar.gz
        - tar zxf helm-v3.11.3-linux-amd64.tar.gz
        - mv linux-amd64/helm /usr/local/bin/helm
    build:
      commands:
        - |
          if [[ -n ${ADDF_PARAMETER_NO_REPLICATE} ]]; then
            python3 get-list-of-eks-images.py --eks-version ${ADDF_PARAMETER_EKS_VERSION} --versions-directory data/eks_dockerimage-replication/versions --update-helm-repos --registry-prefix "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/${AWS_CODESEEDER_NAME}-" --no-replicate
          else
            python3 get-list-of-eks-images.py --eks-version ${ADDF_PARAMETER_EKS_VERSION} --versions-directory data/eks_dockerimage-replication/versions --update-helm-repos --registry-prefix "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/${AWS_CODESEEDER_NAME}-"
          fi
        - chmod +x replication.sh
        - bash replication.sh create
        - export ADDF_MODULE_METADATA=$(python -c "import yaml; import json; file=open('images.yaml'); print(json.dumps(yaml.safe_load(file)))")
destroy:
  phases:
    build:
      commands:
        - chmod +x replication.sh
        - bash replication.sh destroy
build_type: BUILD_GENERAL1_LARGE
